<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bast√≥n Inteligente</title>

<style>
/* ----------- ESTILO PASTEL PARA NI√ëAS ----------- */
body{
  font-family:'Poppins', sans-serif;
  background:#fce7f3;
  color:#4a4a4a;
  margin:0;
  padding:20px;
}

.container{
  max-width:1100px;
  margin:0 auto;
}

.card{
  background:#ffffff;
  padding:20px;
  border-radius:20px;
  margin-bottom:22px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  border:3px solid #f9c6e4;
  transition: all 0.3s ease;
}

.card.alerta{
  border-color:#ef4444;
  animation: pulso 1s infinite;
}

@keyframes pulso {
  0%, 100% { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
  50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.6); }
}

h1{
  font-weight:600;
  text-align:center;
  color:#d946ef;
}

h2{
  color:#c026d3;
}

button{
  margin-top:10px;
  background:#f472b6;
  border:none;
  padding:10px 18px;
  color:white;
  font-size:15px;
  border-radius:10px;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  background:#ec4899;
}

button.secondary{
  background:#a855f7;
}

button.secondary:hover{
  background:#9333ea;
}

.distancia-valor{
  font-size:55px;
  text-align:center;
  font-weight:600;
  color:#db2777;
  transition: color 0.3s;
}

.distancia-valor.peligro{
  color:#ef4444;
}

.estado{
  text-align:center;
  font-size:18px;
  font-weight:500;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

.estado.normal{
  background:#d1fae5;
  color:#065f46;
}

.estado.alerta{
  background:#fee2e2;
  color:#991b1b;
  animation: parpadeo 1s infinite;
}

@keyframes parpadeo {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.historico{
  max-height:300px;
  overflow:auto;
}

.historico div{
  border-bottom:1px solid #f9d8eb;
  padding:8px 4px;
}

.historico div.peligro{
  background:#fee2e2;
  font-weight:500;
  color:#991b1b;
}

img.ultima{
  max-width:100%;
  border-radius:12px;
  border:3px solid #f9c6e4;
}

.alertas-registro{
  max-height:200px;
  overflow:auto;
  margin-top:15px;
}

.alerta-item{
  background:#fee2e2;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
  border-left:4px solid #ef4444;
}

.sonido-control{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
}

.sonido-control label{
  font-weight:500;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:10px;
  margin-top:15px;
}

.stat-box{
  background:#fce7f3;
  padding:15px;
  border-radius:10px;
  text-align:center;
}

.stat-numero{
  font-size:28px;
  font-weight:600;
  color:#d946ef;
}

.stat-etiqueta{
  font-size:13px;
  color:#666;
  margin-top:5px;
}
</style>
</head>

<body>
<div class="container">
  <h1>ü¶Ø Bast√≥n Inteligente - Monitor</h1>

  <!-- TARJETA DE DISTANCIA -->
  <div class="card" id="cardDistancia">
    <h2>Distancia actual</h2>
    <div class="distancia-valor" id="distancia">-- cm</div>
    <div class="estado normal" id="estado">Esperando...</div>
    
    <div class="sonido-control">
      <label>
        <input type="checkbox" id="sonidoCheck" checked> Activar alerta sonora
      </label>
      <label>
        <input type="checkbox" id="vozCheck" checked> Activar alerta de voz
      </label>
    </div>
  </div>

  <!-- ESTAD√çSTICAS -->
  <div class="card">
    <h2>üìä Estad√≠sticas de hoy</h2>
    <div class="stats">
      <div class="stat-box">
        <div class="stat-numero" id="totalAlertas">0</div>
        <div class="stat-etiqueta">Alertas totales</div>
      </div>
      <div class="stat-box">
        <div class="stat-numero" id="ultimaAlerta">--</div>
        <div class="stat-etiqueta">√öltima alerta</div>
      </div>
      <div class="stat-box">
        <div class="stat-numero" id="distanciaMin">--</div>
        <div class="stat-etiqueta">Distancia m√≠nima</div>
      </div>
    </div>
  </div>

  <!-- REGISTRO DE ALERTAS -->
  <div class="card">
    <h2>üö® Registro de Alertas</h2>
    <div class="alertas-registro" id="alertasRegistro">
      <p style="text-align:center; color:#999;">No hay alertas registradas</p>
    </div>
    <button onclick="limpiarAlertas()">Limpiar registro de alertas</button>
  </div>

  <!-- TARJETA DE IMAGEN -->
  <div class="card">
    <h2>üì∏ √öltima imagen (ESP32-CAM)</h2>
    <div id="imagenCont">
      <p>No hay imagen a√∫n</p>
    </div>
  </div>

  <!-- HIST√ìRICO -->
  <div class="card">
    <h2>üìù Hist√≥rico completo</h2>
    <div class="historico" id="historico"></div>
    <button onclick="limpiarHistorico()">Limpiar hist√≥rico</button>
    <button class="secondary" onclick="descargarHistorico()">Descargar datos</button>
  </div>
</div>

<!-- Audio para alertas -->
<audio id="audioAlerta" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLaizsIGGS77OmdTQ0PP6Hk77RiHAU7k9nyzn0vBSF1xe/glEILElyx6OyrWBQLRJre8cJwIQUug9DY3Jk" type="audio/wav">
</audio>

<script>
// --------------------------------------
// CONFIG
// --------------------------------------
const BASE = "";

// Variables de estado
let alertaPrev = false;
let contadorAlertas = 0;
let distanciaMinima = Infinity;
let alertasHoy = [];
let ultimaDistanciaAlerta = null;
let audioContext = null;
let synth = null;

// --------------------------------------
// INICIALIZACI√ìN DE VOZ
// --------------------------------------
if ('speechSynthesis' in window) {
  synth = window.speechSynthesis;
}

// --------------------------------------
// NOTIFICACIONES
// --------------------------------------
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

function enviarNotificacion(mensaje, distancia) {
  if (Notification.permission === "granted") {
    new Notification("üö® Bast√≥n Inteligente - ALERTA", {
      body: `${mensaje}\nDistancia: ${distancia} cm`,
      icon: "https://cdn-icons-png.flaticon.com/128/3917/3917215.png",
      requireInteraction: true,
      tag: 'baston-alerta'
    });
  }
}

// --------------------------------------
// ALERTA SONORA
// --------------------------------------
function reproducirAlertaSonora() {
  const sonidoActivo = document.getElementById('sonidoCheck').checked;
  if (!sonidoActivo) return;

  const audio = document.getElementById('audioAlerta');
  audio.currentTime = 0;
  audio.play().catch(e => console.log('Error audio:', e));
  
  // Sonido adicional con Web Audio API
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = 800;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.5);
}

// --------------------------------------
// ALERTA DE VOZ
// --------------------------------------
function hablarAlerta(distancia) {
  const vozActiva = document.getElementById('vozCheck').checked;
  if (!vozActiva || !synth) return;

  synth.cancel(); // Cancelar cualquier mensaje anterior
  
  let mensaje = '';
  if (distancia < 20) {
    mensaje = '¬°Cuidado! Objeto muy cerca';
  } else if (distancia < 50) {
    mensaje = 'Atenci√≥n, objeto cercano';
  } else {
    mensaje = 'Precauci√≥n';
  }
  
  const utterance = new SpeechSynthesisUtterance(mensaje);
  utterance.lang = 'es-ES';
  utterance.rate = 1.2;
  utterance.pitch = 1.1;
  utterance.volume = 1;
  
  synth.speak(utterance);
}

// --------------------------------------
// REGISTRAR ALERTA
// --------------------------------------
function registrarAlerta(distancia) {
  const ahora = new Date();
  contadorAlertas++;
  
  const alerta = {
    tiempo: ahora.toISOString(),
    distancia: distancia,
    id: Date.now()
  };
  
  alertasHoy.unshift(alerta);
  if (alertasHoy.length > 50) alertasHoy.pop();
  
  actualizarRegistroAlertas();
  actualizarEstadisticas(ahora, distancia);
}

// --------------------------------------
// ACTUALIZAR REGISTRO DE ALERTAS
// --------------------------------------
function actualizarRegistroAlertas() {
  const contenedor = document.getElementById('alertasRegistro');
  
  if (alertasHoy.length === 0) {
    contenedor.innerHTML = '<p style="text-align:center; color:#999;">No hay alertas registradas</p>';
    return;
  }
  
  contenedor.innerHTML = alertasHoy.map(a => `
    <div class="alerta-item">
      <strong>‚ö†Ô∏è ALERTA</strong><br>
      ${new Date(a.tiempo).toLocaleString()}<br>
      Distancia: <strong>${a.distancia.toFixed(1)} cm</strong>
    </div>
  `).join('');
}

// --------------------------------------
// ACTUALIZAR ESTAD√çSTICAS
// --------------------------------------
function actualizarEstadisticas(tiempo, distancia) {
  document.getElementById('totalAlertas').textContent = contadorAlertas;
  document.getElementById('ultimaAlerta').textContent = tiempo.toLocaleTimeString();
  
  if (distancia < distanciaMinima) {
    distanciaMinima = distancia;
    document.getElementById('distanciaMin').textContent = distancia.toFixed(1) + ' cm';
  }
}

// --------------------------------------
// OBTENER DATOS DEL SERVIDOR
// --------------------------------------
async function obtener() {
  try {
    const r = await fetch(BASE + '/api/datos');
    if (!r.ok) throw new Error("no data");
    const data = await r.json();

    const distancia = data.distancia || 0;
    const distanciaEl = document.getElementById('distancia');
    const estadoEl = document.getElementById('estado');
    const cardEl = document.getElementById('cardDistancia');

    // Mostrar distancia
    distanciaEl.textContent = distancia.toFixed(1) + " cm";

    // ALERTA
    if (data.alerta) {
      distanciaEl.classList.add('peligro');
      estadoEl.className = 'estado alerta';
      estadoEl.textContent = "‚ö†Ô∏è ¬°ALERTA! - Objeto cercano detectado";
      cardEl.classList.add('alerta');

      // Solo activar alertas si es una nueva alerta o cambi√≥ significativamente la distancia
      if (!alertaPrev || (ultimaDistanciaAlerta && Math.abs(ultimaDistanciaAlerta - distancia) > 10)) {
        reproducirAlertaSonora();
        hablarAlerta(distancia);
        enviarNotificacion("¬°Objeto muy cercano detectado!", distancia);
        registrarAlerta(distancia);
        
        alertaPrev = true;
        ultimaDistanciaAlerta = distancia;
      }

    } else {
      distanciaEl.classList.remove('peligro');
      estadoEl.className = 'estado normal';
      estadoEl.textContent = "‚úÖ Todo despejado - Sin obst√°culos";
      cardEl.classList.remove('alerta');
      alertaPrev = false;
      ultimaDistanciaAlerta = null;
    }

    // Imagen de ESP32-CAM
    const imgRes = await fetch(BASE + '/api/last_image');
    if (imgRes.status === 200) {
      const info = await imgRes.json();
      document.getElementById('imagenCont').innerHTML =
      `<img class="ultima" src="${BASE}/uploads/${info.filename}" alt="Imagen">
       <div>üìÖ Subido: ${new Date(info.timestamp).toLocaleString()}</div>`;
    }

  } catch (e) {
    console.log(e);
  }
}

// --------------------------------------
// HIST√ìRICO
// --------------------------------------
async function cargarHistorico() {
  try {
    const r = await fetch(BASE + '/api/historico');
    const hist = await r.json();

    document.getElementById('historico').innerHTML =
      hist.map(h => {
        const clase = h.alerta ? ' class="peligro"' : '';
        return `<div${clase}>${new Date(h.tiempo).toLocaleString()} ‚Äî ${h.distancia} cm ${
           h.alerta ? '‚ö†Ô∏è ALERTA' : '‚úÖ'
        }</div>`;
      }).join('');

  } catch(e){ console.log(e); }
}

// --------------------------------------
// LIMPIAR HIST√ìRICO
// --------------------------------------
async function limpiarHistorico() {
  if (!confirm("¬øLimpiar hist√≥rico completo?")) return;

  await fetch(BASE + '/api/limpiar', {
    method:'POST',
    headers: { 'X-API-Key': 'baston123' }
  });

  document.getElementById('historico').innerHTML = '';
  alert('‚úÖ Hist√≥rico limpiado correctamente');
}

// --------------------------------------
// LIMPIAR ALERTAS
// --------------------------------------
function limpiarAlertas() {
  if (!confirm("¬øLimpiar registro de alertas?")) return;
  
  alertasHoy = [];
  contadorAlertas = 0;
  distanciaMinima = Infinity;
  
  actualizarRegistroAlertas();
  document.getElementById('totalAlertas').textContent = '0';
  document.getElementById('ultimaAlerta').textContent = '--';
  document.getElementById('distanciaMin').textContent = '--';
  
  alert('‚úÖ Registro de alertas limpiado');
}

// --------------------------------------
// DESCARGAR HIST√ìRICO
// --------------------------------------
async function descargarHistorico() {
  try {
    const r = await fetch(BASE + '/api/historico');
    const hist = await r.json();
    
    const csv = 'Fecha,Hora,Distancia (cm),Alerta\n' + 
      hist.map(h => {
        const fecha = new Date(h.tiempo);
        return `${fecha.toLocaleDateString()},${fecha.toLocaleTimeString()},${h.distancia},${h.alerta ? 'S√≠' : 'No'}`;
      }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `baston_historico_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
  } catch(e){ 
    alert('Error al descargar: ' + e.message);
  }
}

// --------------------------------------
// ACTUALIZACI√ìN AUTOM√ÅTICA
// --------------------------------------
setInterval(()=>{ obtener(); cargarHistorico(); }, 2000);
obtener(); cargarHistorico();

// Cargar alertas guardadas (si existen)
window.addEventListener('load', () => {
  console.log('ü¶Ø Sistema de alertas del Bast√≥n Inteligente activado');
});
</script>

</body>
</html>
