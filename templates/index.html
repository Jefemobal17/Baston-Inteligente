<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bast√≥n Inteligente con GPS</title>

<style>
body{
  font-family:'Poppins', sans-serif;
  background:#fce7f3;
  color:#4a4a4a;
  margin:0;
  padding:20px;
}

.container{
  max-width:1100px;
  margin:0 auto;
}

.card{
  background:#ffffff;
  padding:20px;
  border-radius:20px;
  margin-bottom:22px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  border:3px solid #f9c6e4;
  transition: all 0.3s ease;
}

.card.alerta{
  border-color:#ef4444;
  animation: pulso 1s infinite;
}

@keyframes pulso {
  0%, 100% { box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
  50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.6); }
}

h1{
  font-weight:600;
  text-align:center;
  color:#d946ef;
  margin-bottom:30px;
}

h2{
  color:#c026d3;
  margin-top:0;
}

button{
  margin-top:10px;
  background:#f472b6;
  border:none;
  padding:10px 18px;
  color:white;
  font-size:15px;
  border-radius:10px;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  background:#ec4899;
}

button.secondary{
  background:#a855f7;
}

button.secondary:hover{
  background:#9333ea;
}

.distancia-valor{
  font-size:55px;
  text-align:center;
  font-weight:600;
  color:#db2777;
  transition: color 0.3s;
}

.distancia-valor.peligro{
  color:#ef4444;
}

.estado{
  text-align:center;
  font-size:18px;
  font-weight:500;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

.estado.normal{
  background:#d1fae5;
  color:#065f46;
}

.estado.alerta{
  background:#fee2e2;
  color:#991b1b;
  animation: parpadeo 1s infinite;
}

@keyframes parpadeo {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.gps-info{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:15px;
  margin-top:15px;
}

.gps-dato{
  background:#f3f4f6;
  padding:15px;
  border-radius:10px;
  border-left:4px solid #d946ef;
}

.gps-label{
  font-size:13px;
  color:#666;
  font-weight:500;
  margin-bottom:5px;
}

.gps-valor{
  font-size:20px;
  color:#1f2937;
  font-weight:600;
  font-family:monospace;
}

.gps-mapa{
  text-align:center;
  margin-top:15px;
}

.gps-mapa a{
  display:inline-block;
  background:#10b981;
  color:white;
  padding:12px 24px;
  border-radius:10px;
  text-decoration:none;
  font-weight:500;
  transition:0.2s;
}

.gps-mapa a:hover{
  background:#059669;
  transform:scale(1.05);
}

.gps-estado{
  display:inline-block;
  padding:8px 16px;
  border-radius:8px;
  font-size:15px;
  font-weight:500;
  margin-bottom:15px;
}

.gps-estado.valido{
  background:#d1fae5;
  color:#065f46;
}

.gps-estado.buscando{
  background:#fef3c7;
  color:#92400e;
}

.gps-estado.invalido{
  background:#fee2e2;
  color:#991b1b;
}

.historico{
  max-height:300px;
  overflow:auto;
}

.historico div{
  border-bottom:1px solid #f9d8eb;
  padding:8px 4px;
  font-size:14px;
}

.historico div.peligro{
  background:#fee2e2;
  font-weight:500;
  color:#991b1b;
}

.alertas-registro{
  max-height:200px;
  overflow:auto;
  margin-top:15px;
}

.alerta-item{
  background:#fee2e2;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
  border-left:4px solid #ef4444;
  font-size:14px;
}

.sonido-control{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:15px;
  margin-top:10px;
}

.sonido-control label{
  font-weight:500;
  display:flex;
  align-items:center;
  gap:5px;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:10px;
  margin-top:15px;
}

.stat-box{
  background:#fce7f3;
  padding:15px;
  border-radius:10px;
  text-align:center;
}

.stat-numero{
  font-size:28px;
  font-weight:600;
  color:#d946ef;
}

.stat-etiqueta{
  font-size:13px;
  color:#666;
  margin-top:5px;
}

.grid-2{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
  gap:22px;
  margin-bottom:22px;
}

@media (max-width: 768px){
  .gps-info{
    grid-template-columns:1fr;
  }
  .grid-2{
    grid-template-columns:1fr;
  }
}
</style>
</head>

<body>
<div class="container">
  <h1>ü¶Ø Bast√≥n Inteligente - Monitor GPS</h1>

  <!-- ALERTA DE PERMISOS -->
  <div class="card" id="alertaPermisos" style="display:none; background:#fef3c7; border-color:#f59e0b;">
    <h2 style="color:#92400e;">üîî Activa las Notificaciones</h2>
    <p style="color:#92400e;">Para recibir alertas de peligro en tiempo real, necesitas activar las notificaciones del navegador.</p>
    <button onclick="solicitarPermisoNotificaciones()" style="background:#f59e0b;">‚úÖ Activar Notificaciones</button>
    <button onclick="cerrarAlertaPermisos()" class="secondary">‚ùå Cerrar</button>
  </div>

  <!-- FILA CON DISTANCIA Y GPS -->
  <div class="grid-2">
    <!-- TARJETA DE DISTANCIA -->
    <div class="card" id="cardDistancia">
      <h2>üìè Distancia actual</h2>
      <div class="distancia-valor" id="distancia">-- cm</div>
      <div class="estado normal" id="estado">Esperando datos...</div>
      
      <div class="sonido-control">
        <label>
          <input type="checkbox" id="sonidoCheck" checked> üîä Sonido
        </label>
        <label>
          <input type="checkbox" id="vozCheck" checked> üó£Ô∏è Voz
        </label>
      </div>
    </div>

    <!-- TARJETA GPS -->
    <div class="card">
      <h2>üìç Ubicaci√≥n GPS</h2>
      <div id="gpsEstado" class="gps-estado buscando">‚è≥ Buscando sat√©lites...</div>
      
      <div class="gps-info">
        <div class="gps-dato">
          <div class="gps-label">üåç Latitud</div>
          <div class="gps-valor" id="latitud">--</div>
        </div>
        <div class="gps-dato">
          <div class="gps-label">üåç Longitud</div>
          <div class="gps-valor" id="longitud">--</div>
        </div>
        <div class="gps-dato">
          <div class="gps-label">üõ∞Ô∏è Sat√©lites</div>
          <div class="gps-valor" id="satelites">0</div>
        </div>
      </div>
      
      <div class="gps-mapa">
        <a href="#" id="verMapa" target="_blank" style="display:none;">
          üó∫Ô∏è Ver ubicaci√≥n en Google Maps
        </a>
      </div>
    </div>
  </div>

  <!-- ESTAD√çSTICAS -->
  <div class="card">
    <h2>üìä Estad√≠sticas de hoy</h2>
    <div class="stats">
      <div class="stat-box">
        <div class="stat-numero" id="totalAlertas">0</div>
        <div class="stat-etiqueta">Alertas totales</div>
      </div>
      <div class="stat-box">
        <div class="stat-numero" id="ultimaAlerta">--</div>
        <div class="stat-etiqueta">√öltima alerta</div>
      </div>
      <div class="stat-box">
        <div class="stat-numero" id="distanciaMin">--</div>
        <div class="stat-etiqueta">Distancia m√≠nima</div>
      </div>
      <div class="stat-box">
        <div class="stat-numero" id="ultimaActualizacion">--</div>
        <div class="stat-etiqueta">√öltima actualizaci√≥n</div>
      </div>
    </div>
  </div>

  <!-- REGISTRO DE ALERTAS -->
  <div class="card">
    <h2>üö® Registro de Alertas Recientes</h2>
    <div class="alertas-registro" id="alertasRegistro">
      <p style="text-align:center; color:#999;">No hay alertas registradas</p>
    </div>
    <button onclick="limpiarAlertas()">üóëÔ∏è Limpiar alertas</button>
  </div>

  <!-- HIST√ìRICO -->
  <div class="card">
    <h2>üìù Hist√≥rico Completo</h2>
    <div class="historico" id="historico">
      <p style="text-align:center; color:#999; padding:20px;">Cargando datos...</p>
    </div>
    <button onclick="limpiarHistorico()">üóëÔ∏è Limpiar hist√≥rico</button>
    <button class="secondary" onclick="descargarHistorico()">üíæ Descargar CSV</button>
  </div>
</div>

<audio id="audioAlerta" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLaizsIGGS77OmdTQ0PP6Hk77RiHAU7k9nyzn0vBSF1xe/glEILElyx6OyrWBQLRJre8cJwIQUug9DY3Jk" type="audio/wav">
</audio>

<script>
// IMPORTANTE: Cambia esta URL por la de tu servidor en Render.com
const BASE = "https://baston-inteligente.onrender.com"; // ‚ö†Ô∏è CAMBIAR POR TU URL

let alertaPrev = false;
let contadorAlertas = 0;
let distanciaMinima = Infinity;
let alertasHoy = [];
let ultimaDistanciaAlerta = null;
let audioContext = null;
let synth = null;

// Variables GPS
let gpsLatitud = null;
let gpsLongitud = null;
let gpsSatelites = 0;
let gpsValido = false;
let primeraLecturaGPS = true;

if ('speechSynthesis' in window) {
  synth = window.speechSynthesis;
}

// Verificar permisos de notificaciones al cargar
function verificarPermisosNotificaciones() {
  if (Notification.permission === "default") {
    document.getElementById('alertaPermisos').style.display = 'block';
  } else if (Notification.permission === "denied") {
    console.warn('‚ö†Ô∏è Las notificaciones est√°n bloqueadas. Act√≠valas en la configuraci√≥n del navegador.');
  } else {
    console.log('‚úÖ Notificaciones activadas');
  }
}

function solicitarPermisoNotificaciones() {
  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      alert('‚úÖ Notificaciones activadas correctamente');
      document.getElementById('alertaPermisos').style.display = 'none';
      // Enviar notificaci√≥n de prueba
      new Notification("ü¶Ø Bast√≥n Inteligente", {
        body: "Las notificaciones est√°n activadas. Recibir√°s alertas de peligro.",
        icon: "https://cdn-icons-png.flaticon.com/128/3917/3917215.png"
      });
    } else {
      alert('‚ùå Las notificaciones fueron bloqueadas. Act√≠valas manualmente en la configuraci√≥n del navegador.');
    }
  });
}

function cerrarAlertaPermisos() {
  document.getElementById('alertaPermisos').style.display = 'none';
}

function enviarNotificacion(mensaje, distancia) {
  if (Notification.permission === "granted") {
    // Crear notificaci√≥n con m√°s informaci√≥n
    let body = `${mensaje}\nüìè Distancia: ${distancia.toFixed(1)} cm`;
    
    // Agregar ubicaci√≥n GPS si est√° disponible
    if (gpsLatitud && gpsLongitud) {
      body += `\nüìç Ubicaci√≥n: ${gpsLatitud.toFixed(6)}, ${gpsLongitud.toFixed(6)}`;
    }
    
    const notification = new Notification("üö® BAST√ìN INTELIGENTE - PELIGRO", {
      body: body,
      icon: "https://cdn-icons-png.flaticon.com/128/3917/3917215.png",
      badge: "https://cdn-icons-png.flaticon.com/128/3917/3917215.png",
      requireInteraction: true,
      tag: 'baston-alerta-' + Date.now(),
      vibrate: [200, 100, 200], // Vibraci√≥n en m√≥viles
      silent: false
    });
    
    // Cerrar autom√°ticamente despu√©s de 10 segundos
    setTimeout(() => notification.close(), 10000);
    
    // Acci√≥n al hacer click en la notificaci√≥n
    notification.onclick = function() {
      window.focus();
      this.close();
      
      // Si hay GPS, abrir en Google Maps
      if (gpsLatitud && gpsLongitud) {
        const confirmar = confirm('¬øQuieres ver la ubicaci√≥n del peligro en Google Maps?');
        if (confirmar) {
          window.open(`https://www.google.com/maps?q=${gpsLatitud},${gpsLongitud}`, '_blank');
        }
      }
    };
  } else if (Notification.permission === "default") {
    console.log('‚ö†Ô∏è Solicitando permisos de notificaci√≥n...');
    Notification.requestPermission();
  }
}

function reproducirAlertaSonora() {
  const sonidoActivo = document.getElementById('sonidoCheck').checked;
  if (!sonidoActivo) return;

  const audio = document.getElementById('audioAlerta');
  audio.currentTime = 0;
  audio.play().catch(e => console.log('Error audio:', e));
  
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = 800;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.5);
}

function hablarAlerta(distancia) {
  const vozActiva = document.getElementById('vozCheck').checked;
  if (!vozActiva || !synth) return;

  synth.cancel();
  
  let mensaje = '';
  if (distancia < 20) {
    mensaje = '¬°Cuidado! Objeto muy cerca';
  } else if (distancia < 50) {
    mensaje = 'Atenci√≥n, objeto cercano';
  } else {
    mensaje = 'Precauci√≥n';
  }
  
  const utterance = new SpeechSynthesisUtterance(mensaje);
  utterance.lang = 'es-ES';
  utterance.rate = 1.2;
  utterance.pitch = 1.1;
  utterance.volume = 1;
  
  synth.speak(utterance);
}

function registrarAlerta(distancia) {
  const ahora = new Date();
  contadorAlertas++;
  
  const alerta = {
    tiempo: ahora.toISOString(),
    distancia: distancia,
    latitud: gpsLatitud,
    longitud: gpsLongitud,
    satelites: gpsSatelites,
    id: Date.now()
  };
  
  alertasHoy.unshift(alerta);
  if (alertasHoy.length > 50) alertasHoy.pop();
  
  actualizarRegistroAlertas();
  actualizarEstadisticas(ahora, distancia);
}

function actualizarRegistroAlertas() {
  const contenedor = document.getElementById('alertasRegistro');
  
  if (alertasHoy.length === 0) {
    contenedor.innerHTML = '<p style="text-align:center; color:#999;">No hay alertas registradas</p>';
    return;
  }
  
  contenedor.innerHTML = alertasHoy.map(a => {
    let ubicacion = '';
    if (a.latitud && a.longitud) {
      ubicacion = `<br>üìç <strong>Ubicaci√≥n:</strong> ${a.latitud.toFixed(6)}, ${a.longitud.toFixed(6)}
                   <br>üõ∞Ô∏è ${a.satelites || 0} sat√©lites`;
    } else {
      ubicacion = '<br>üìç <em>GPS no disponible</em>';
    }
    return `
    <div class="alerta-item">
      <strong>‚ö†Ô∏è ALERTA</strong><br>
      üïê ${new Date(a.tiempo).toLocaleString()}<br>
      üìè Distancia: <strong>${a.distancia.toFixed(1)} cm</strong>${ubicacion}
    </div>
  `}).join('');
}

function actualizarEstadisticas(tiempo, distancia) {
  document.getElementById('totalAlertas').textContent = contadorAlertas;
  document.getElementById('ultimaAlerta').textContent = tiempo.toLocaleTimeString();
  
  if (distancia < distanciaMinima) {
    distanciaMinima = distancia;
    document.getElementById('distanciaMin').textContent = distancia.toFixed(1) + ' cm';
  }
}

function actualizarGPS(lat, lng, sats) {
  gpsLatitud = lat;
  gpsLongitud = lng;
  gpsSatelites = sats;
  gpsValido = true;
  
  document.getElementById('latitud').textContent = lat.toFixed(6);
  document.getElementById('longitud').textContent = lng.toFixed(6);
  document.getElementById('satelites').textContent = sats;
  
  const estadoGPS = document.getElementById('gpsEstado');
  
  if (sats >= 4) {
    estadoGPS.className = 'gps-estado valido';
    estadoGPS.textContent = '‚úÖ GPS Activo - Se√±al buena';
  } else if (sats > 0) {
    estadoGPS.className = 'gps-estado buscando';
    estadoGPS.textContent = '‚è≥ GPS Parcial - Buscando m√°s sat√©lites';
  }
  
  const enlaceMapa = document.getElementById('verMapa');
  enlaceMapa.style.display = 'inline-block';
  enlaceMapa.href = `https://www.google.com/maps?q=${lat},${lng}`;
  
  if (primeraLecturaGPS && sats >= 4) {
    console.log('‚úÖ GPS conectado exitosamente');
    primeraLecturaGPS = false;
  }
}

function mostrarGPSInvalido() {
  const estadoGPS = document.getElementById('gpsEstado');
  estadoGPS.className = 'gps-estado buscando';
  estadoGPS.textContent = '‚è≥ Buscando sat√©lites GPS...';
  
  document.getElementById('verMapa').style.display = 'none';
}

async function obtener() {
  try {
    const r = await fetch(BASE + '/api/datos');
    if (!r.ok) throw new Error("no data");
    const data = await r.json();

    const distancia = data.distancia || 0;
    const distanciaEl = document.getElementById('distancia');
    const estadoEl = document.getElementById('estado');
    const cardEl = document.getElementById('cardDistancia');

    distanciaEl.textContent = distancia.toFixed(1) + " cm";
    
    // Actualizar √∫ltima actualizaci√≥n
    document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString();

    // Actualizar GPS
    if (data.latitud !== null && data.longitud !== null && data.latitud !== undefined && data.longitud !== undefined) {
      actualizarGPS(data.latitud, data.longitud, data.satelites || 0);
    } else {
      mostrarGPSInvalido();
    }

    // Manejo de alertas
    if (data.alerta) {
      distanciaEl.classList.add('peligro');
      estadoEl.className = 'estado alerta';
      estadoEl.textContent = "‚ö†Ô∏è ¬°ALERTA! - Objeto cercano detectado";
      cardEl.classList.add('alerta');

      if (!alertaPrev || (ultimaDistanciaAlerta && Math.abs(ultimaDistanciaAlerta - distancia) > 10)) {
        reproducirAlertaSonora();
        hablarAlerta(distancia);
        enviarNotificacion("¬°Objeto muy cercano detectado!", distancia);
        registrarAlerta(distancia);
        
        alertaPrev = true;
        ultimaDistanciaAlerta = distancia;
      }

    } else {
      distanciaEl.classList.remove('peligro');
      estadoEl.className = 'estado normal';
      estadoEl.textContent = "‚úÖ Todo despejado - Sin obst√°culos";
      cardEl.classList.remove('alerta');
      alertaPrev = false;
      ultimaDistanciaAlerta = null;
    }

  } catch (e) {
    console.log('Error obteniendo datos:', e);
    document.getElementById('estado').textContent = "‚ö†Ô∏è Error de conexi√≥n";
  }
}

async function cargarHistorico() {
  try {
    const r = await fetch(BASE + '/api/historico');
    const hist = await r.json();

    if (hist.length === 0) {
      document.getElementById('historico').innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No hay datos en el hist√≥rico</p>';
      return;
    }

    document.getElementById('historico').innerHTML =
      hist.map(h => {
        const clase = h.alerta ? ' class="peligro"' : '';
        let gpsInfo = '';
        if (h.latitud && h.longitud) {
          gpsInfo = ` | üìç ${h.latitud.toFixed(4)}, ${h.longitud.toFixed(4)} (${h.satelites || 0} sats)`;
        }
        return `<div${clase}>${new Date(h.tiempo).toLocaleString()} ‚Äî ${h.distancia} cm ${
           h.alerta ? '‚ö†Ô∏è ALERTA' : '‚úÖ'
        }${gpsInfo}</div>`;
      }).join('');

  } catch(e){ 
    console.log('Error cargando hist√≥rico:', e);
  }
}

async function limpiarHistorico() {
  if (!confirm("¬øSeguro que deseas limpiar todo el hist√≥rico?")) return;

  try {
    await fetch(BASE + '/api/limpiar', {
      method:'POST',
      headers: { 'X-API-Key': 'baston123' }
    });

    document.getElementById('historico').innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No hay datos en el hist√≥rico</p>';
    alert('‚úÖ Hist√≥rico limpiado correctamente');
  } catch(e) {
    alert('‚ùå Error al limpiar: ' + e.message);
  }
}

function limpiarAlertas() {
  if (!confirm("¬øLimpiar el registro de alertas de hoy?")) return;
  
  alertasHoy = [];
  contadorAlertas = 0;
  distanciaMinima = Infinity;
  
  actualizarRegistroAlertas();
  document.getElementById('totalAlertas').textContent = '0';
  document.getElementById('ultimaAlerta').textContent = '--';
  document.getElementById('distanciaMin').textContent = '--';
  
  alert('‚úÖ Registro de alertas limpiado');
}

async function descargarHistorico() {
  try {
    const r = await fetch(BASE + '/api/historico');
    const hist = await r.json();
    
    if (hist.length === 0) {
      alert('‚ö†Ô∏è No hay datos para descargar');
      return;
    }
    
    const csv = 'Fecha,Hora,Distancia (cm),Alerta,Latitud,Longitud,Satelites\n' + 
      hist.map(h => {
        const fecha = new Date(h.tiempo);
        return `${fecha.toLocaleDateString()},${fecha.toLocaleTimeString()},${h.distancia},${h.alerta ? 'S√≠' : 'No'},${h.latitud || ''},${h.longitud || ''},${h.satelites || ''}`;
      }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `baston_gps_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Archivo descargado correctamente');
    
  } catch(e){ 
    alert('‚ùå Error al descargar: ' + e.message);
  }
}

// Actualizar datos cada 2 segundos
setInterval(() => { 
  obtener(); 
  cargarHistorico(); 
}, 2000);

// Cargar datos iniciales
obtener(); 
cargarHistorico();

window.addEventListener('load', () => {
  console.log('ü¶Ø Sistema de Bast√≥n Inteligente con GPS inicializado');
  console.log('üì° Esperando datos del sensor y GPS...');
  
  // Verificar permisos de notificaciones
  verificarPermisosNotificaciones();
});
</script>

</body>
</html>
