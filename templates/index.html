<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bast√≥n Inteligente</title>
<style>
/* (usa el CSS que ya ten√≠as; aqu√≠ lo acorto para brevedad) */
body{font-family:Arial,Helvetica,sans-serif;background:#0f172a;color:#fff;padding:20px}
.container{max-width:1100px;margin:0 auto}
.card{background:rgba(255,255,255,0.06);padding:20px;border-radius:12px;margin-bottom:16px}
.distancia-valor{font-size:56px;text-align:center}
.historico{max-height:300px;overflow:auto}
img.ultima{max-width:100%;border-radius:8px}
</style>
</head>
<body>
<div class="container">
  <h1>ü¶Ø Bast√≥n Inteligente - Monitor</h1>

  <div class="card">
    <h2>Distancia actual</h2>
    <div class="distancia-valor" id="distancia">-- cm</div>
    <div id="estado">Esperando...</div>
  </div>

  <div class="card">
    <h2>√öltima imagen (ESP32-CAM)</h2>
    <div id="imagenCont">
      <p>No hay imagen a√∫n</p>
    </div>
  </div>

  <div class="card">
    <h2>Hist√≥rico</h2>
    <div class="historico" id="historico"></div>
    <button onclick="limpiarHistorico()">Limpiar hist√≥rico</button>
  </div>
</div>

<script>
const BASE = ""; // si lo despliegas en mismo dominio de Render, deja vac√≠o. Sino pon 'https://mi-proyecto.onrender.com'
async function obtener() {
  try {
    const r = await fetch(BASE + '/api/datos');
    if (!r.ok) throw new Error("no data");
    const data = await r.json();
    document.getElementById('distancia').textContent = (data.distancia || 0).toFixed(1) + " cm";
    if (data.alerta) document.getElementById('estado').textContent = "‚ö†Ô∏è ALERTA";
    else document.getElementById('estado').textContent = "‚úÖ Normal";

    // imagen
    const imgRes = await fetch(BASE + '/api/last_image');
    if (imgRes.status === 200) {
      const info = await imgRes.json();
      document.getElementById('imagenCont').innerHTML = `<img class="ultima" src="${BASE}/uploads/${info.filename}" alt="√öltima imagen"> <div>Subido: ${new Date(info.timestamp).toLocaleString()}</div>`;
    }

  } catch (e) {
    console.log(e);
  }
}

async function cargarHistorico() {
  try {
    const r = await fetch(BASE + '/api/historico');
    const hist = await r.json();
    const div = document.getElementById('historico');
    div.innerHTML = hist.map(h => `<div>${new Date(h.tiempo).toLocaleString()} ‚Äî ${h.distancia} cm ${h.alerta? '‚ö†Ô∏è' : ''}</div>`).join('');
  } catch(e){ console.log(e) }
}

async function limpiarHistorico() {
  if (!confirm("Limpiar hist√≥rico?")) return;
  await fetch(BASE + '/api/limpiar', {method:'POST', headers: {'X-API-Key': 'baston123'}});
  document.getElementById('historico').innerHTML = '';
  alert('Hist√≥rico limpiado');
}

setInterval(()=>{ obtener(); cargarHistorico(); }, 2000);
obtener(); cargarHistorico();
</script>
</body>
</html>
