<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bast√≥n Inteligente</title>

<style>
/* ----------- ESTILO PASTEL PARA NI√ëAS ----------- */
body{
  font-family:'Poppins', sans-serif;
  background:#fce7f3; /* Rosa pastel */
  color:#4a4a4a;
  margin:0;
  padding:20px;
  transition: background 0.3s ease;
}

.container{
  max-width:1100px;
  margin:0 auto;
}

.card{
  background:#ffffff;
  padding:20px;
  border-radius:20px;
  margin-bottom:22px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  border:3px solid #f9c6e4;
}

h1{
  font-weight:600;
  text-align:center;
  color:#d946ef;
}

h2{
  color:#c026d3;
}

button{
  margin-top:10px;
  background:#f472b6;
  border:none;
  padding:10px 18px;
  color:white;
  font-size:15px;
  border-radius:10px;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  background:#ec4899;
}

.distancia-valor{
  font-size:55px;
  text-align:center;
  font-weight:600;
  color:#db2777;
}

.historico{
  max-height:300px;
  overflow:auto;
}

.historico div{
  border-bottom:1px solid #f9d8eb;
  padding:4px 0;
}

img.ultima{
  max-width:100%;
  border-radius:12px;
  border:3px solid #f9c6e4;
}

/* Animaci√≥n de shake para alertas */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Bot√≥n de notificaciones */
.notif-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #8b5cf6;
  color: white;
  border: none;
  padding: 15px 20px;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-weight: bold;
  z-index: 1000;
}

.notif-btn:hover {
  background: #7c3aed;
}

/* Alerta parpadeante */
.alerta-activa {
  animation: shake 0.5s infinite;
}
</style>
</head>

<body>
<div class="container">
  <h1>ü¶Ø Bast√≥n Inteligente - Monitor</h1>

  <!-- TARJETA DE DISTANCIA -->
  <div class="card" id="cardDistancia">
    <h2>Distancia actual</h2>
    <div class="distancia-valor" id="distancia">-- cm</div>
    <div id="estado">Esperando...</div>
  </div>

  <!-- TARJETA DE IMAGEN -->
  <div class="card">
    <h2>√öltima imagen (ESP32-CAM)</h2>
    <div id="imagenCont">
      <p>No hay imagen a√∫n</p>
    </div>
  </div>

  <!-- HIST√ìRICO -->
  <div class="card">
    <h2>Hist√≥rico</h2>
    <div class="historico" id="historico"></div>
    <button onclick="limpiarHistorico()">Limpiar hist√≥rico</button>
  </div>
</div>

<script>
// --------------------------------------
// CONFIG (Render usa mismo dominio: BASE = "")
// --------------------------------------
const BASE = "";

// --------------------------------------
// NOTIFICACIONES MEJORADAS
// --------------------------------------
let alertaPrev = false;
let ultimaNotificacion = 0;
const INTERVALO_NOTIFICACION = 3000; // Notificar cada 3 segundos si persiste la alerta

// Solicitar permisos al cargar
async function solicitarPermisos() {
    if (Notification.permission === "default") {
        const permiso = await Notification.requestPermission();
        if (permiso === "granted") {
            console.log("‚úÖ Notificaciones activadas");
            mostrarMensaje("‚úÖ Notificaciones activadas correctamente", "success");
        } else {
            console.log("‚ùå Notificaciones bloqueadas");
            mostrarMensaje("‚ö†Ô∏è Por favor activa las notificaciones", "warning");
        }
    }
}

// Llamar al inicio
solicitarPermisos();

function enviarNotificacion(mensaje, tipo = "alerta") {
    const ahora = Date.now();
    
    // Evitar spam de notificaciones
    if (tipo === "alerta" && ahora - ultimaNotificacion < INTERVALO_NOTIFICACION) {
        return;
    }
    
    if (Notification.permission === "granted") {
        const notificacion = new Notification("üö® Bast√≥n Inteligente - ALERTA", {
            body: mensaje,
            icon: "https://cdn-icons-png.flaticon.com/128/3917/3917215.png",
            badge: "https://cdn-icons-png.flaticon.com/128/3917/3917215.png",
            tag: "baston-alerta", // Evita duplicados
            requireInteraction: true, // Mantiene la notificaci√≥n visible
            vibrate: [200, 100, 200, 100, 200], // Vibraci√≥n en m√≥vil
            silent: false
        });
        
        // Reproducir sonido de alerta
        reproducirSonido();
        
        // Click en notificaci√≥n enfoca la ventana
        notificacion.onclick = function() {
            window.focus();
            this.close();
        };
        
        ultimaNotificacion = ahora;
        console.log("üì¢ Notificaci√≥n enviada:", mensaje);
    } else {
        console.warn("‚ö†Ô∏è Permiso de notificaciones no concedido");
        // Mostrar alerta visual en la p√°gina
        mostrarAlertaVisual(mensaje);
    }
}

// Sonido de alerta
function reproducirSonido() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800; // Frecuencia del beep
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch(e) {
        console.log("No se pudo reproducir sonido:", e);
    }
}

// Alerta visual alternativa si no hay permisos
function mostrarAlertaVisual(mensaje) {
    const alerta = document.createElement('div');
    alerta.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #dc2626;
        color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        font-weight: bold;
        animation: shake 0.5s;
        max-width: 300px;
    `;
    alerta.textContent = "üö® " + mensaje;
    document.body.appendChild(alerta);
    
    setTimeout(() => alerta.remove(), 5000);
}

// Mensaje de sistema
function mostrarMensaje(texto, tipo) {
    const colores = {
        success: '#16a34a',
        warning: '#ea580c',
        info: '#2563eb'
    };
    
    const msg = document.createElement('div');
    msg.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${colores[tipo] || colores.info};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: 500;
    `;
    msg.textContent = texto;
    document.body.appendChild(msg);
    
    setTimeout(() => msg.remove(), 3000);
}

// --------------------------------------
// OBTENER DATOS DEL SERVIDOR
// --------------------------------------
async function obtener() {
  try {
    const r = await fetch(BASE + '/api/datos');
    if (!r.ok) throw new Error("no data");
    const data = await r.json();

    // Mostrar distancia
    document.getElementById('distancia').textContent =
      (data.distancia || 0).toFixed(1) + " cm";

    const cardDistancia = document.getElementById('cardDistancia');

    // ALERTA
    if (data.alerta) {
      document.getElementById('estado').innerHTML =
        '<span style="color:#dc2626;font-weight:bold;font-size:18px;">üö® ALERTA - Objeto cercano</span>';

      // A√±adir animaci√≥n shake a la tarjeta
      cardDistancia.classList.add('alerta-activa');

      // Notificar con detalle de distancia
      if (!alertaPrev || Date.now() - ultimaNotificacion >= INTERVALO_NOTIFICACION) {
        enviarNotificacion(
          `‚ö†Ô∏è PELIGRO: Objeto a ${(data.distancia || 0).toFixed(1)} cm del bast√≥n`,
          "alerta"
        );
        alertaPrev = true;
      }

      // Cambiar color de fondo en alerta
      document.body.style.background = '#fee2e2';

    } else {
      document.getElementById('estado').innerHTML = 
        '<span style="color:#16a34a;">‚úÖ Normal - Sin obst√°culos</span>';
      
      // Quitar animaci√≥n
      cardDistancia.classList.remove('alerta-activa');
      
      // Si antes hab√≠a alerta y ahora no, notificar que se despej√≥
      if (alertaPrev) {
        enviarNotificacion("‚úÖ V√≠a despejada - Alerta terminada", "normal");
      }
      
      alertaPrev = false;
      document.body.style.background = '#fce7f3';
    }

    // Imagen de ESP32-CAM
    const imgRes = await fetch(BASE + '/api/last_image');

    if (imgRes.status === 200) {
      const info = await imgRes.json();
      document.getElementById('imagenCont').innerHTML =
      `<img class="ultima" src="${BASE}/uploads/${info.filename}" alt="Imagen">
       <div>Subido: ${new Date(info.timestamp).toLocaleString()}</div>`;
    }

  } catch (e) {
    console.log(e);
  }
}

// --------------------------------------
// HIST√ìRICO
// --------------------------------------
async function cargarHistorico() {
  try {
    const r = await fetch(BASE + '/api/historico');
    const hist = await r.json();

    document.getElementById('historico').innerHTML =
      hist.map(h =>
        `<div>${new Date(h.tiempo).toLocaleString()} ‚Äî ${h.distancia} cm ${
           h.alerta ? '‚ö†Ô∏è' : ''
        }</div>`
      ).join('');

  } catch(e){ console.log(e); }
}

// --------------------------------------
// LIMPIAR HIST√ìRICO
// --------------------------------------
async function limpiarHistorico() {
  if (!confirm("¬øLimpiar hist√≥rico completo?")) return;

  await fetch(BASE + '/api/limpiar', {
    method:'POST',
    headers: { 'X-API-Key': 'baston123' }
  });

  document.getElementById('historico').innerHTML = '';
  mostrarMensaje('Hist√≥rico limpiado correctamente', 'success');
}

// --------------------------------------
// ACTUALIZACI√ìN AUTOM√ÅTICA
// --------------------------------------
setInterval(()=>{ obtener(); cargarHistorico(); }, 2000);
obtener(); cargarHistorico();

// Bot√≥n flotante para activar notificaciones manualmente
const btnNotif = document.createElement('button');
btnNotif.className = 'notif-btn';
btnNotif.innerHTML = 'üîî Activar Notificaciones';
btnNotif.onclick = async () => {
  await solicitarPermisos();
  if (Notification.permission === "granted") {
    btnNotif.innerHTML = '‚úÖ Notificaciones ON';
    setTimeout(() => btnNotif.style.display = 'none', 2000);
  }
};

// Mostrar bot√≥n solo si no est√°n activadas
if (Notification.permission !== "granted") {
  document.body.appendChild(btnNotif);
}
</script>

</body>
</html>
